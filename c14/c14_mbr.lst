     1                                           ;代码清单14-1
     2                                           ;文件名：c14_mbr.asm
     3                                           ;文件说明：硬盘主引导扇区代码 
     4                                           ;创建日期：2011-10-27 22:52
     5                                  
     6                                           ;设置堆栈段和栈指针 
     7 00000000 668CC8                           mov eax,cs      
     8 00000003 8ED0                             mov ss,eax
     9 00000005 BC007C                           mov sp,0x7c00
    10                                        
    11                                           ;计算GDT所在的逻辑段地址
    12 00000008 2E66A1[497D]                     mov eax,[cs:pgdt+0x7c00+0x02]      ;GDT的32位线性基地址 
    13 0000000D 6631D2                           xor edx,edx
    14 00000010 66BB10000000                     mov ebx,16
    15 00000016 66F7F3                           div ebx                            ;分解成16位逻辑地址 
    16                                  
    17 00000019 8ED8                             mov ds,eax                         ;令DS指向该段以进行操作
    18 0000001B 6689D3                           mov ebx,edx                        ;段内起始偏移地址 
    19                                  
    20                                           ;创建0#描述符，它是空描述符，这是处理器的要求
    21 0000001E 6667C70300000000                 mov dword [ebx+0x00],0x00000000
    22 00000026 6667C7430400000000               mov dword [ebx+0x04],0x00000000  
    23                                  
    24                                           ;创建1#描述符，这是一个数据段，对应0~4GB的线性地址空间
    25 0000002F 6667C74308FFFF0000               mov dword [ebx+0x08],0x0000ffff    ;基地址为0，段界限为0xfffff
    26 00000038 6667C7430C0092CF00               mov dword [ebx+0x0c],0x00cf9200    ;粒度为4KB，存储器段描述符 
    27                                  
    28                                           ;创建保护模式下初始代码段描述符
    29 00000041 6667C74310FF01007C               mov dword [ebx+0x10],0x7c0001ff    ;基地址为0x00007c00，512字节 
    30 0000004A 6667C7431400984000               mov dword [ebx+0x14],0x00409800    ;粒度为1个字节，代码段描述符 
    31                                  
    32                                           ;创建以上代码段的别名描述符
    33 00000053 6667C74318FF01007C               mov dword [ebx+0x18],0x7c0001ff    ;基地址为0x00007c00，512字节
    34 0000005C 6667C7431C00924000               mov dword [ebx+0x1c],0x00409200    ;粒度为1个字节，数据段描述符
    35                                  
    36 00000065 6667C74320FEFF007C               mov dword [ebx+0x20],0x7c00fffe    ;基地址为0x00007c00，界限为0xffffe
    37 0000006E 6667C743240096CF00               mov dword [ebx+0x24],0x00cf9600    ;粒度为4KB，向下扩展
    38                                           
    39                                           ;初始化描述符表寄存器GDTR
    40 00000077 2EC706[477D]2700                 mov word [cs: pgdt+0x7c00],39      ;描述符表的界限   
    41                                   
    42 0000007E 2E0F0116[477D]                   lgdt [cs: pgdt+0x7c00]
    43                                        
    44 00000084 E492                             in al,0x92                         ;南桥芯片内的端口 
    45 00000086 0C02                             or al,0000_0010B
    46 00000088 E692                             out 0x92,al                        ;打开A20
    47                                  
    48 0000008A FA                               cli                                ;中断机制尚未工作
    49                                  
    50 0000008B 0F20C0                           mov eax,cr0
    51 0000008E 6683C801                         or eax,1
    52 00000092 0F22C0                           mov cr0,eax                        ;设置PE位
    53                                        
    54                                           ;以下进入保护模式... ...
    55 00000095 66EA[9D000000]1000               jmp 0x0010:dword flush             ;16位的描述符选择子：32位偏移
    56                                  
    57                                           [bits 32]                          
    58                                    flush:                                     
    59 0000009D B818000000                       mov eax,0x0018                      
    60 000000A2 8ED8                             mov ds,eax
    61                                        
    62 000000A4 B808000000                       mov eax,0x0008                     ;加载数据段(0..4GB)选择子
    63 000000A9 8EC0                             mov es,eax
    64 000000AB 8EE0                             mov fs,eax
    65 000000AD 8EE8                             mov gs,eax
    66                                        
    67 000000AF B820000000                       mov eax,0x0020                     ;0000 0000 0010 0000
    68 000000B4 8ED0                             mov ss,eax
    69 000000B6 31E4                             xor esp,esp                        ;ESP <- 0
    70                                        
    71 000000B8 26C70500800B005007-              mov dword [es:0x0b8000],0x072e0750 ;字符'P'、'.'及其显示属性
    71 000000C1 2E07               
    72 000000C3 26C70504800B004D07-              mov dword [es:0x0b8004],0x072e074d ;字符'M'、'.'及其显示属性
    72 000000CC 2E07               
    73 000000CE 26C70508800B002007-              mov dword [es:0x0b8008],0x07200720 ;两个空白字符及其显示属性
    73 000000D7 2007               
    74 000000D9 26C7050C800B006F07-              mov dword [es:0x0b800c],0x076b076f ;字符'o'、'k'及其显示属性
    74 000000E2 6B07               
    75                                  
    76                                           ;开始冒泡排序 
    77 000000E4 B924000000                       mov ecx,pgdt-string-1              ;遍历次数=串长度-1 
    78                                    @@1:
    79 000000E9 51                               push ecx                           ;32位模式下的loop使用ecx 
    80 000000EA 6631DB                           xor bx,bx                          ;32位模式下，偏移量可以是16位，也可以 
    81                                    @@2:                                      ;是后面的32位 
    82 000000ED 66678B87[2201]                   mov ax,[string+bx] 
    83 000000F3 38C4                             cmp ah,al                          ;ah中存放的是源字的高字节 
    84 000000F5 7D08                             jge @@3 
    85 000000F7 86C4                             xchg al,ah 
    86 000000F9 66678987[2201]                   mov [string+bx],ax 
    87                                    @@3:
    88 000000FF 6643                             inc bx 
    89 00000101 E2EA                             loop @@2 
    90 00000103 59                               pop ecx 
    91 00000104 E2E3                             loop @@1
    92                                        
    93 00000106 B925000000                       mov ecx,pgdt-string
    94 0000010B 31DB                             xor ebx,ebx                        ;偏移地址是32位的情况 
    95                                    @@4:                                      ;32位的偏移具有更大的灵活性
    96 0000010D B407                             mov ah,0x07
    97 0000010F 8A83[22010000]                   mov al,[string+ebx]
    98 00000115 266689841BA0800B00               mov [es:0xb80a0+ebx*2],ax          ;演示0~4GB寻址。
    99 0000011E 43                               inc ebx
   100 0000011F E2EC                             loop @@4
   101                                        
   102 00000121 F4                               hlt 
   103                                  
   104                                  ;-------------------------------------------------------------------------------
   105 00000122 73306B65346F723932-          string           db 's0ke4or92xap3fv8giuzjcy5l1m7hd6bnqtw.'
   105 0000012B 786170336676386769-
   105 00000134 757A6A6379356C316D-
   105 0000013D 37686436626E717477-
   105 00000146 2E                 
   106                                  ;-------------------------------------------------------------------------------
   107 00000147 0000                         pgdt             dw 0
   108 00000149 007E0000                                      dd 0x00007e00      ;GDT的物理地址
   109                                  ;-------------------------------------------------------------------------------                             
   110 0000014D 00<rep B1h>                  times 510-($-$$) db 0
   111 000001FE 55AA                                          db 0x55,0xaa
