     1                                           ;代码清单13-1
     2                                           ;文件名：c13_mbr.asm
     3                                           ;文件说明：硬盘主引导扇区代码
     4                                           ;创建日期：2020-6-22 18:00，修改于2022-02-17 22：12
     5                                  
     6                                           ;设置初始的栈段和栈指针
     7 00000000 8CC8                             mov ax,cs
     8 00000002 8ED0                             mov ss,ax
     9 00000004 BC007C                           mov sp,0x7c00
    10                                  
    11                                           ;计算GDT所在的逻辑段地址
    12 00000007 2EA1[E47C]                       mov ax,[cs:gdt_base+0x7c00]        ;低16位 
    13 0000000B 2E8B16[E67C]                     mov dx,[cs:gdt_base+0x7c00+0x02]   ;高16位 
    14 00000010 BB1000                           mov bx,16        
    15 00000013 F7F3                             div bx            
    16 00000015 8ED8                             mov ds,ax                          ;令DS指向该段以进行操作
    17 00000017 89D3                             mov bx,dx                          ;段内起始偏移地址 
    18                                        
    19                                           ;创建0#描述符，它是空描述符，这是处理器的要求
    20 00000019 66C70700000000                   mov dword [bx+0x00],0x00
    21 00000020 66C7470400000000                 mov dword [bx+0x04],0x00  
    22                                  
    23                                           ;创建#1描述符，保护模式下的数据段描述符（文本模式下的显示缓冲区）
    24 00000028 66C74708FFFF0080                 mov dword [bx+0x08],0x8000ffff
    25 00000030 66C7470C0B924000                 mov dword [bx+0x0c],0x0040920b
    26                                  
    27                                           ;创建#2描述符，保护模式下的代码段描述符
    28 00000038 66C74710FF01007C                 mov dword [bx+0x10],0x7c0001ff
    29 00000040 66C7471400984000                 mov dword [bx+0x14],0x00409800
    30                                  
    31                                           ;初始化描述符表寄存器GDTR
    32 00000048 2EC706[E27C]1700                 mov word [cs: gdt_size+0x7c00],23  ;描述符表的界限（总字节数减一）
    33                                                                               
    34 0000004F 2E0F0116[E27C]                   lgdt [cs: gdt_size+0x7c00]
    35                                        
    36 00000055 E492                             in al,0x92                         ;南桥芯片内的端口 
    37 00000057 0C02                             or al,0000_0010B
    38 00000059 E692                             out 0x92,al                        ;打开A20
    39                                  
    40 0000005B FA                               cli                                ;保护模式下中断机制尚未建立，应 
    41                                                                              ;禁止中断 
    42 0000005C 0F20C0                           mov eax,cr0
    43 0000005F 6683C801                         or eax,1
    44 00000063 0F22C0                           mov cr0,eax                        ;设置PE位
    45                                  
    46                                           ;以下进入保护模式... ...
    47 00000066 EA[6B00]1000                     jmp 0000000000010_0_00B:flush      ;jmp 0x0010:flush
    48                                  
    49                                           bits 32
    50                                  
    51                                  flush:
    52 0000006B 66B90800                         mov cx,0000000000001_0_00B         ;加载数据段选择子(0x08)
    53 0000006F 8ED9                             mov ds,cx
    54                                  
    55                                           ;以下在屏幕上显示"Protect mode OK."
    56 00000071 C6050000000050                   mov byte [0x00],'P'
    57 00000078 C6050200000072                   mov byte [0x02],'r'
    58 0000007F C605040000006F                   mov byte [0x04],'o'
    59 00000086 C6050600000074                   mov byte [0x06],'t'
    60 0000008D C6050800000065                   mov byte [0x08],'e'
    61 00000094 C6050A00000063                   mov byte [0x0a],'c'
    62 0000009B C6050C00000074                   mov byte [0x0c],'t'
    63 000000A2 C6050E00000020                   mov byte [0x0e],' '
    64 000000A9 C605100000006D                   mov byte [0x10],'m'
    65 000000B0 C605120000006F                   mov byte [0x12],'o'
    66 000000B7 C6051400000064                   mov byte [0x14],'d'
    67 000000BE C6051600000065                   mov byte [0x16],'e'
    68 000000C5 C6051800000020                   mov byte [0x18],' '
    69 000000CC C6051A0000004F                   mov byte [0x1a],'O'
    70 000000D3 C6051C0000004B                   mov byte [0x1c],'K'
    71 000000DA C6051E0000002E                   mov byte [0x1e],'.'
    72                                  
    73 000000E1 F4                               hlt                                ;已经禁止中断，将不会被唤醒 
    74                                  
    75                                  ;-------------------------------------------------------------------------------
    76                                       
    77 000000E2 0000                             gdt_size         dw 0
    78 000000E4 007E0000                         gdt_base         dd 0x00007e00     ;GDT的物理地址 
    79                                                               
    80 000000E8 00<rep 116h>                     times 510-($-$$) db 0
    81 000001FE 55AA                                              db 0x55,0xaa
