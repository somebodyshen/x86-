     1                                           ;代码清单12-1
     2                                           ;文件名：c12_mbr.asm
     3                                           ;文件说明：硬盘主引导扇区代码
     4                                           ;创建日期：2011-5-16 19:54；修改于2022-02-16 11:15
     5                                  
     6                                           ;设置堆栈段和栈指针
     7 00000000 8CC8                             mov ax, cs
     8 00000002 8ED0                             mov ss, ax
     9 00000004 BC007C                           mov sp, 0x7c00
    10                                  
    11                                           ;计算GDT所在的逻辑段地址
    12 00000007 2EA1[AE7C]                       mov ax, [cs: gdt_base + 0x7c00]              ;低16位
    13 0000000B 2E8B16[B07C]                     mov dx, [cs: gdt_base + 0x7c00 + 0x02]       ;高16位
    14 00000010 BB1000                           mov bx, 16
    15 00000013 F7F3                             div bx
    16                                  
    17 00000015 8ED8                             mov ds, ax                                   ;令DS指向该段以进行操作
    18 00000017 89D3                             mov bx, dx                                   ;段内起始偏移地址
    19                                  
    20                                           ;创建0#描述符，它是空描述符，这是处理器的要求
    21 00000019 66C70700000000                   mov dword [bx+0x00],0x00
    22 00000020 66C7470400000000                 mov dword [bx+0x04],0x00
    23                                  
    24                                           ;创建#1描述符，保护模式下的数据段描述符（文本模式下的显示缓冲区）
    25 00000028 66C74708FFFF0080                 mov dword [bx+0x08],0x8000ffff
    26 00000030 66C7470C0B924000                 mov dword [bx+0x0c],0x0040920b
    27                                  
    28                                           ;初始化描述符表寄存器GDTR
    29 00000038 2EC706[AC7C]0F00                 mov word [cs: gdt_size+0x7c00],15            ;描述符表的界限（总字节数减一）
    30                                  
    31 0000003F 2E0F0116[AC7C]                   lgdt [cs: gdt_size+0x7c00]
    32                                  
    33 00000045 E492                             in al,0x92                                   ;南桥芯片内的端口
    34 00000047 0C02                             or al,0000_0010B
    35 00000049 E692                             out 0x92,al                                  ;打开A20
    36                                  
    37 0000004B FA                               cli                                          ;保护模式下中断机制尚未建立，应
    38                                                                                        ;禁止中断
    39 0000004C 0F20C0                           mov eax,cr0
    40 0000004F 6683C801                         or eax,1
    41 00000053 0F22C0                           mov cr0,eax                                  ;设置PE位
    42                                  
    43                                           ;以下进入保护模式... ...
    44                                  
    45 00000056 B90800                           mov cx,00000000000_01_000B                   ;加载数据段选择子(0x08)
    46 00000059 8ED9                             mov ds,cx
    47                                  
    48                                           ;以下在屏幕上显示"Protect mode OK."
    49 0000005B C606000050                       mov byte [0x00],'P'
    50 00000060 C606020072                       mov byte [0x02],'r'
    51 00000065 C60604006F                       mov byte [0x04],'o'
    52 0000006A C606060074                       mov byte [0x06],'t'
    53 0000006F C606080065                       mov byte [0x08],'e'
    54 00000074 C6060A0063                       mov byte [0x0a],'c'
    55 00000079 C6060C0074                       mov byte [0x0c],'t'
    56 0000007E C6060E0020                       mov byte [0x0e],' '
    57 00000083 C60610006D                       mov byte [0x10],'m'
    58 00000088 C60612006F                       mov byte [0x12],'o'
    59 0000008D C606140064                       mov byte [0x14],'d'
    60 00000092 C606160065                       mov byte [0x16],'e'
    61 00000097 C606180020                       mov byte [0x18],' '
    62 0000009C C6061A004F                       mov byte [0x1a],'O'
    63 000000A1 C6061C004B                       mov byte [0x1c],'K'
    64 000000A6 C6061E002E                       mov byte [0x1e],'.'
    65                                  
    66 000000AB F4                               hlt                                          ;已经禁止中断，将不会被唤醒
    67                                  
    68                                  ;-------------------------------------------------------------------------------
    69                                  
    70 000000AC 0000                             gdt_size         dw 0
    71 000000AE 007E0000                         gdt_base         dd 0x00007e00               ;GDT的物理地址
    72                                  
    73 000000B2 00<rep 14Ch>                     times 510-($-$$) db 0
    74 000001FE 55AA                                              db 0x55,0xaa
